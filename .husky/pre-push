echo "Running pre-push checks..."

echo "Checking linting..."
pnpm lint || {
  echo "Linting failed. Please fix errors before pushing."
  exit 1
}

echo "Checking formatting..."
pnpm format:check || {
  echo "Formatting check failed. Run 'pnpm format' to fix."
  exit 1
}

echo "Checking spelling..."
pnpm spell || {
  echo "Spell check failed. Please fix spelling errors."
  exit 1
}

echo "Checking for unused code..."
pnpm knip || {
  echo "Knip found unused code. Please review and fix."
  exit 1
}

echo "Running tests..."
pnpm test --run || {
  echo "Tests failed. Please fix failing tests before pushing."
  exit 1
}

# Run e2e tests first, then visual tests (sequential to avoid port conflicts)
echo "Running e2e tests..."
pnpm e2e || {
  echo "E2E tests failed. Please fix failing tests before pushing."
  exit 1
}

echo "Running visual screenshot tests (desktop browsers only)..."
# Skip mobile-chrome in pre-push as it has flaky touch/overlay interactions
# Full mobile testing is done in CI
PLAYWRIGHT_VISUAL=1 playwright test e2e/tests/visual/ --project=chromium --project=firefox --project=webkit || {
  echo "Visual tests failed. Please review screenshot changes."
  echo "To update screenshots: pnpm e2e:visual:update"
  exit 1
}

echo "E2E and visual tests passed!"

echo "All pre-push checks passed!"
