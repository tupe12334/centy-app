echo "Running pre-push checks..."

echo "Checking linting..."
pnpm lint || {
  echo "Linting failed. Please fix errors before pushing."
  exit 1
}

echo "Checking formatting..."
pnpm format:check || {
  echo "Formatting check failed. Run 'pnpm format' to fix."
  exit 1
}

echo "Checking spelling..."
pnpm spell || {
  echo "Spell check failed. Please fix spelling errors."
  exit 1
}

echo "Checking for unused code..."
pnpm knip || {
  echo "Knip found unused code. Please review and fix."
  exit 1
}

echo "Running tests..."
pnpm test --run || {
  echo "Tests failed. Please fix failing tests before pushing."
  exit 1
}

# Run e2e and visual tests in parallel for faster execution
echo "Running e2e tests and visual screenshot tests in parallel..."

# Create temp files for exit codes
E2E_EXIT_FILE=$(mktemp)
VISUAL_EXIT_FILE=$(mktemp)

# Run e2e tests in background
(
  pnpm e2e
  echo $? > "$E2E_EXIT_FILE"
) &
E2E_PID=$!

# Run ALL visual tests in background
(
  pnpm e2e:visual
  echo $? > "$VISUAL_EXIT_FILE"
) &
VISUAL_PID=$!

# Wait for both to complete
wait $E2E_PID
wait $VISUAL_PID

# Read exit codes
E2E_EXIT=$(cat "$E2E_EXIT_FILE")
VISUAL_EXIT=$(cat "$VISUAL_EXIT_FILE")

# Cleanup temp files
rm -f "$E2E_EXIT_FILE" "$VISUAL_EXIT_FILE"

# Check results
if [ "$E2E_EXIT" != "0" ]; then
  echo "E2E tests failed. Please fix failing tests before pushing."
  exit 1
fi

if [ "$VISUAL_EXIT" != "0" ]; then
  echo "Visual tests failed. Please review screenshot changes."
  echo "To update screenshots: pnpm e2e:visual:update"
  exit 1
fi

echo "E2e and visual tests passed!"

echo "All pre-push checks passed!"
